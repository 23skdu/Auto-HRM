<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HRM Autonomous Agent Dashboard</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .status-card {
            border-left: 4px solid #007bff;
            transition: all 0.3s ease;
        }
        .status-card.training {
            border-left-color: #28a745;
        }
        .status-card.error {
            border-left-color: #dc3545;
        }
        .status-card.intervention {
            border-left-color: #ffc107;
        }
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        .control-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }
        .log-container {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Courier New', monospace;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
        }
        .progress-ring {
            transform: rotate(-90deg);
        }
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform-origin: 50% 50%;
        }
        .navbar-brand {
            font-weight: bold;
            color: #667eea !important;
        }
        .btn-custom {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 500;
        }
        .alert-custom {
            border-radius: 10px;
            border: none;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-brain"></i> HRM Autonomous Agent
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text" id="last-update">
                    Last Update: <span id="update-time">--</span>
                </span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Status Overview -->
            <div class="col-md-3">
                <div class="card status-card mb-4" id="status-card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="fas fa-circle" id="status-indicator"></i>
                            System Status
                        </h5>
                        <h3 class="text-primary" id="system-status">Idle</h3>
                        <p class="card-text">
                            <small class="text-muted">
                                Epoch: <span id="current-epoch">0</span> | 
                                Step: <span id="global-step">0</span>
                            </small>
                        </p>
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="card metric-card mb-4">
                    <div class="card-body text-center">
                        <h6 class="card-title">Overall Performance</h6>
                        <div class="position-relative d-inline-block">
                            <svg class="progress-ring" width="80" height="80">
                                <circle class="progress-ring-circle" stroke="white" stroke-width="4" 
                                        fill="transparent" r="36" cx="40" cy="40" 
                                        stroke-dasharray="226.19" stroke-dashoffset="226.19" id="performance-circle"/>
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle">
                                <span class="h4" id="performance-score">0%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h6 class="card-title">Quick Stats</h6>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <h5 class="text-primary mb-0" id="dataset-size">0</h5>
                                    <small class="text-muted">Samples</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h5 class="text-success mb-0" id="best-performance">0.0</h5>
                                <small class="text-muted">Best Score</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9">
                <!-- Control Panel -->
                <div class="control-panel mb-4">
                    <div class="row">
                        <div class="col-md-8">
                            <h5><i class="fas fa-cogs"></i> Control Panel</h5>
                            <div class="btn-group me-2" role="group">
                                <button type="button" class="btn btn-success btn-custom" id="start-training">
                                    <i class="fas fa-play"></i> Start Training
                                </button>
                                <button type="button" class="btn btn-danger btn-custom" id="stop-training" disabled>
                                    <i class="fas fa-stop"></i> Stop Training
                                </button>
                            </div>
                            <div class="btn-group me-2" role="group">
                                <button type="button" class="btn btn-info btn-custom" id="collect-data">
                                    <i class="fas fa-database"></i> Collect Data
                                </button>
                                <button type="button" class="btn btn-warning btn-custom" id="evaluate-model">
                                    <i class="fas fa-chart-line"></i> Evaluate Model
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-end">
                                <button type="button" class="btn btn-outline-primary btn-custom" data-bs-toggle="modal" data-bs-target="#configModal">
                                    <i class="fas fa-sliders-h"></i> Configuration
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alerts -->
                <div id="alerts-container"></div>

                <!-- Charts Row -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h6><i class="fas fa-chart-line"></i> Training Progress</h6>
                            <div id="training-chart" style="height: 300px;"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h6><i class="fas fa-radar-chart"></i> Performance Metrics</h6>
                            <div id="performance-chart" style="height: 300px;"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h6><i class="fas fa-database"></i> Data Distribution</h6>
                            <div id="data-chart" style="height: 300px;"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h6><i class="fas fa-terminal"></i> System Logs</h6>
                            <div class="log-container" id="logs-container">
                                <div>System initialized...</div>
                                <div>Waiting for commands...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Modal -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Training Configuration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="config-form">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Training Parameters</h6>
                                <div class="mb-3">
                                    <label class="form-label">Batch Size</label>
                                    <input type="number" class="form-control" name="batch_size" value="16">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Learning Rate</label>
                                    <input type="number" class="form-control" name="learning_rate" value="0.00002" step="0.00001">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Number of Epochs</label>
                                    <input type="number" class="form-control" name="num_epochs" value="3">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Max Training Time (hours)</label>
                                    <input type="number" class="form-control" name="max_training_time" value="24">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Model Parameters</h6>
                                <div class="mb-3">
                                    <label class="form-label">Model Dimension</label>
                                    <input type="number" class="form-control" name="d_model" value="512">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Number of Heads</label>
                                    <input type="number" class="form-control" name="n_heads" value="8">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Feed Forward Dimension</label>
                                    <input type="number" class="form-control" name="d_ff" value="2048">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Max Halt Steps</label>
                                    <input type="number" class="form-control" name="halt_max_steps" value="8">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-config">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Global state
        let trainingActive = false;
        
        // Initialize dashboard
        $(document).ready(function() {
            loadInitialData();
            setupEventHandlers();
            setupSocketHandlers();
        });
        
        function loadInitialData() {
            // Load status
            $.get('/api/status', function(data) {
                updateStatus(data);
            });
            
            // Load charts
            loadTrainingHistory();
            loadPerformanceMetrics();
            loadDataStats();
        }
        
        function setupEventHandlers() {
            // Start training
            $('#start-training').click(function() {
                const config = getFormData('#config-form');
                
                $.ajax({
                    url: '/api/start_training',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(config),
                    success: function(response) {
                        showAlert('success', response.message);
                        trainingActive = true;
                        updateTrainingButtons();
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON?.error || 'Unknown error';
                        showAlert('danger', 'Error starting training: ' + error);
                    }
                });
            });
            
            // Stop training
            $('#stop-training').click(function() {
                $.post('/api/stop_training', function(response) {
                    showAlert('warning', response.message);
                    trainingActive = false;
                    updateTrainingButtons();
                });
            });
            
            // Collect data
            $('#collect-data').click(function() {
                $.post('/api/collect_data', function(response) {
                    showAlert('info', response.message);
                });
            });
            
            // Evaluate model
            $('#evaluate-model').click(function() {
                $.post('/api/evaluate_model', function(response) {
                    showAlert('info', response.message);
                });
            });
            
            // Save configuration
            $('#save-config').click(function() {
                const config = getFormData('#config-form');
                
                $.ajax({
                    url: '/api/model_config',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(config),
                    success: function(response) {
                        showAlert('success', response.message);
                        $('#configModal').modal('hide');
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON?.error || 'Unknown error';
                        showAlert('danger', 'Error saving configuration: ' + error);
                    }
                });
            });
        }
        
        function setupSocketHandlers() {
            socket.on('status_update', function(data) {
                updateStatus(data);
            });
            
            socket.on('training_progress', function(data) {
                updateTrainingProgress(data);
                loadTrainingHistory(); // Refresh chart
            });
            
            socket.on('evaluation_complete', function(data) {
                showAlert('success', 'Model evaluation completed');
                loadPerformanceMetrics();
            });
            
            socket.on('data_collection_complete', function(data) {
                showAlert('success', 'Data collection completed');
                loadDataStats();
            });
            
            socket.on('intervention_needed', function(data) {
                showAlert('warning', data.message, true);
            });
            
            socket.on('fatal_error', function(data) {
                showAlert('danger', 'Fatal error: ' + data.message, true);
                trainingActive = false;
                updateTrainingButtons();
            });
            
            socket.on('training_complete', function(data) {
                showAlert('success', 'Training completed successfully');
                trainingActive = false;
                updateTrainingButtons();
            });
        }
        
        function updateStatus(data) {
            $('#system-status').text(data.status || 'Unknown');
            $('#current-epoch').text(data.current_epoch || 0);
            $('#global-step').text(data.global_step || 0);
            $('#dataset-size').text(data.dataset_size || 0);
            $('#best-performance').text((data.best_performance || 0).toFixed(3));
            $('#update-time').text(new Date(data.last_update).toLocaleTimeString());
            
            // Update status indicator
            const statusCard = $('#status-card');
            const statusIndicator = $('#status-indicator');
            
            statusCard.removeClass('training error intervention');
            
            switch(data.status) {
                case 'training':
                    statusCard.addClass('training');
                    statusIndicator.removeClass().addClass('fas fa-circle text-success');
                    trainingActive = true;
                    break;
                case 'error':
                case 'fatal_error':
                    statusCard.addClass('error');
                    statusIndicator.removeClass().addClass('fas fa-circle text-danger');
                    trainingActive = false;
                    break;
                case 'intervention_needed':
                    statusCard.addClass('intervention');
                    statusIndicator.removeClass().addClass('fas fa-circle text-warning');
                    break;
                default:
                    statusIndicator.removeClass().addClass('fas fa-circle text-secondary');
                    trainingActive = false;
            }
            
            updateTrainingButtons();
            
            // Update performance circle
            if (data.performance_metrics && data.performance_metrics.overall) {
                updatePerformanceCircle(data.performance_metrics.overall);
            }
        }
        
        function updatePerformanceCircle(score) {
            const circle = document.getElementById('performance-circle');
            const scoreText = document.getElementById('performance-score');
            
            const radius = 36;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (score * circumference);
            
            circle.style.strokeDashoffset = offset;
            scoreText.textContent = Math.round(score * 100) + '%';
        }
        
        function updateTrainingButtons() {
            $('#start-training').prop('disabled', trainingActive);
            $('#stop-training').prop('disabled', !trainingActive);
        }
        
        function updateTrainingProgress(data) {
            addLogMessage(`Training progress - Epoch: ${data.epoch}, Step: ${data.step}, Performance: ${data.performance.toFixed(3)}`);
        }
        
        function loadTrainingHistory() {
            $.get('/api/training_history', function(data) {
                if (data.graph) {
                    Plotly.newPlot('training-chart', JSON.parse(data.graph).data, JSON.parse(data.graph).layout, {responsive: true});
                }
            });
        }
        
        function loadPerformanceMetrics() {
            $.get('/api/performance_metrics', function(data) {
                if (data.graph) {
                    Plotly.newPlot('performance-chart', JSON.parse(data.graph).data, JSON.parse(data.graph).layout, {responsive: true});
                }
            });
        }
        
        function loadDataStats() {
            $.get('/api/data_stats', function(data) {
                if (data.graph) {
                    Plotly.newPlot('data-chart', JSON.parse(data.graph).data, JSON.parse(data.graph).layout, {responsive: true});
                }
            });
        }
        
        function showAlert(type, message, persistent = false) {
            const alertId = 'alert-' + Date.now();
            const alertHtml = `
                <div class="alert alert-${type} alert-custom alert-dismissible fade show" role="alert" id="${alertId}">
                    <i class="fas fa-${getAlertIcon(type)}"></i> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            $('#alerts-container').append(alertHtml);
            
            if (!persistent) {
                setTimeout(() => {
                    $('#' + alertId).alert('close');
                }, 5000);
            }
            
            addLogMessage(`[${type.toUpperCase()}] ${message}`);
        }
        
        function getAlertIcon(type) {
            const icons = {
                'success': 'check-circle',
                'danger': 'exclamation-triangle',
                'warning': 'exclamation-circle',
                'info': 'info-circle'
            };
            return icons[type] || 'info-circle';
        }
        
        function addLogMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = $('#logs-container');
            const logEntry = `<div>[${timestamp}] ${message}</div>`;
            
            logContainer.append(logEntry);
            logContainer.scrollTop(logContainer[0].scrollHeight);
            
            // Keep only last 100 log entries
            const logs = logContainer.children();
            if (logs.length > 100) {
                logs.first().remove();
            }
        }
        
        function getFormData(formSelector) {
            const formData = {};
            $(formSelector + ' input, ' + formSelector + ' select, ' + formSelector + ' textarea').each(function() {
                const name = $(this).attr('name');
                const value = $(this).val();
                
                if (name && value !== '') {
                    // Convert numeric values
                    if ($(this).attr('type') === 'number') {
                        formData[name] = parseFloat(value);
                    } else {
                        formData[name] = value;
                    }
                }
            });
            return formData;
        }
        
        // Auto-refresh data every 30 seconds
        setInterval(function() {
            if (!trainingActive) {
                $.get('/api/status', function(data) {
                    updateStatus(data);
                });
            }
        }, 30000);
    </script>
</body>
</html>